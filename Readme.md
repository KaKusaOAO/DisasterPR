![災難公關](./docs/icon.png)
# 災難公關

這是一個以 C# 實作的「災難公關」遊戲程式庫，同時實作了簡單的伺服器和[客戶端](https://github.com/KaKusaOAO/DisasterPR-Unity/)。

這個專案的出現主要是因為身為玩家常常會遇到遊戲相關問題，像是斷線的玩家沒有被妥善處理、遊戲在後台會被凍結無法動作等問題，所以想自己實作一個版本出來並嘗試解決這些問題。

這個實作解決的問題有：

* 官方版災難公關是沒有真正的伺服器的，只有一個「無驗證方式的 Firebase 資料庫」。
  * 這意味著目前可以對資料庫內容 (即遊戲狀態) 從外部做任何更動
  * 有心玩家可以透過這個機制提交出「任意內容字卡」或是選擇「任意內容題目」
    * 不局限於遊戲已定義的卡包
    
* 遊戲在後台時（在看其他分頁時）改為不會讓遊戲狀態凍結。
  * 有如以上所解釋，官方版災難公關沒有一個真正的伺服器，所以：
    * 不能正確偵測到玩家斷線
    * 所有遊戲事件都由房主端操控，所以房主不可以斷線
  * 所以解決方法就是實作一個伺服器，讓伺服器掌握每個玩家的連線狀況。
  
* 遊戲計時改由伺服器控制。
  * 官方版的倒數計時效果由每個玩家端的遊戲控制。
  * 至於倒數完會發生什麼事還是由房主端的遊戲控制。
    * 所以房主的遊戲若處於凍結狀態，將不能進行下一步驟。
    
* 玩家斷線會依照遊戲狀態而有不同的處理方式：
  * 在等待開始遊戲期間斷線時，會被移出房間。
  * 在遊戲期間斷線時，會變成 AI 玩家代玩。
    * 期間玩家可嘗試用一樣的名稱再次進入同個遊戲繼續遊玩。
  * 官方版不會對斷線玩家採取措施，也沒有方法可以讓斷線玩家重返遊戲。

這個實作新增的功能有：

* 理論上可以支援到無限多格填空。
  * 實際遊玩會被手中持有的 11 張卡牌限制，而且太多空格會大幅度影響可玩性。
  * 但是終於可以玩到 3 格空格的題目了。
* 玩家可以輸入指令以達成某些目前在介面中無法直接使用的功能。
  * 目前可以用 `/ai` 指令加入 AI 玩家。（可能會變動）
  * 可以用 `/session ...` 指令完成房間相關的進階操作。
* 可以支援到 8 人。
  * 其實原作應該就有計畫要支援到 8 人，因為有相關的介面素材。
* 玩家可以鎖定持有的卡牌，供之後回合使用。
  * 鎖定的卡牌無法使用。
  * 鎖定的卡牌不會在每回合被重置，而是會被保留。

## 關於 `DisasterPR.Proxy`

這是以伺服器連線到災難公關資料庫的代理伺服器，主要目的在於示範目前資料庫缺乏驗證管道，以致於可以對遊戲狀態進行操作的問題。 (Proof of Concept)

目前已測試過可以讓連線到代理的客戶端加入官方版災難公關開啟的房間，並遊玩過整個遊戲到結束。

已知這樣的資料庫問題會導致：

* 可以提交出「任意內容字卡」或是選擇「任意內容題目」
  * 所謂任意內容，就是想寫什麼就寫什麼，已經沒有「卡包」的限制了。
* 可以直接使一個房間無效化
* 可以將房間設定值指定為不合理的數值
* 可以影響到其他房間的狀態

## 實作相關分享（？）

網路封包的相關處理是由 Minecraft 啟發的。封包格式有點像是：
```
這個封包大概這麼大。
以下是我的封包。
    這個封包是「更新玩家的分數」。
    玩家是 .... 。
    分數是 .... 。
以上是我的封包。
```

更多相關的封包處理可以參考 https://wiki.vg/ ，因為大部分都是受 Minecraft 啟發。
